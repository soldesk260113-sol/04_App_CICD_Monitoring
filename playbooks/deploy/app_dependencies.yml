# ═══════════════════════════════════════════════════════════════════════════
# Playbook 08: Deploy App Dependencies
# - production Namespace 생성
# - Harbor ImagePullSecret (harbor-secret)
# - Auth/Chat API Secret (authchat-secret)
#
# NOTE: Redis는 ArgoCD가 apps/redis-cache를 통해 자동 배포하므로 여기서 제외.
# ═══════════════════════════════════════════════════════════════════════════
- name: Deploy App Dependencies (Namespace & Secrets)
  hosts: K8S_Primary_Master
  become: yes
  tasks:
    # ───────────────────────────────────────────────────────────────────────────
    # 1. Namespace
    # ───────────────────────────────────────────────────────────────────────────
    - name: 1. Ensure 'production' namespace exists
      shell: kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -

    # ───────────────────────────────────────────────────────────────────────────
    # 2. Harbor ImagePullSecret
    # (Jenkins가 빌드한 이미지를 K8s가 당겨오기 위해 필요)
    # ───────────────────────────────────────────────────────────────────────────
    - name: 2. Create 'harbor-secret' for Docker Registry
      shell: >
        kubectl create secret docker-registry harbor-secret
        --docker-server={{ harbor_registry }}
        --docker-username={{ harbor_user }}
        --docker-password={{ harbor_pass }}
        --docker-email={{ harbor_email }}
        -n production
        --dry-run=client -o yaml | kubectl apply -f -

    # ───────────────────────────────────────────────────────────────────────────
    # 3. auth-chat-api Secret
    # DB 접속 정보와 JWT 시크릿을 포함합니다.
    # 실제 값은 배포 전에 반드시 수정하세요!
    # ───────────────────────────────────────────────────────────────────────────
    - name: 3. Create 'authchat-secret' for auth-chat-api
      shell: >
        kubectl create secret generic authchat-secret
        --from-literal=DB_HOST="{{ authchat_db_host }}"
        --from-literal=DB_PORT="{{ authchat_db_port }}"
        --from-literal=DB_NAME="{{ authchat_db_name }}"
        --from-literal=DB_USER="{{ authchat_db_user }}"
        --from-literal=DB_PASS="{{ authchat_db_pass }}"
        --from-literal=JWT_SECRET="{{ authchat_jwt_secret }}"
        --from-literal=ACCESS_MIN="{{ authchat_access_min }}"
        -n production
        --dry-run=client -o yaml | kubectl apply -f -