# ───────────────────────────────────────────────────────────────────────────
# Sub-task: Migrate Single GitHub Repository to Gitea
# ───────────────────────────────────────────────────────────────────────────

- name: "[{{ repo.gitea_repo }}] 1. Clone from GitHub"
  git:
    repo: "https://github.com/{{ repo.github_org }}/{{ repo.github_repo }}.git"
    dest: "{{ temp_dir }}/{{ repo.gitea_repo }}"
    clone: yes
    update: yes
  ignore_errors: yes

- name: "[{{ repo.gitea_repo }}] 2. Create Gitea Repository"
  uri:
    url: "{{ gitea_url }}/api/v1/user/repos"
    method: POST
    user: "{{ gitea_user }}"
    password: "{{ gitea_pass }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ repo.gitea_repo }}"
      private: false
      auto_init: false
    status_code: [201, 409]
  register: gitea_create

- name: "[{{ repo.gitea_repo }}] 3. Push to Gitea"
  shell: |
    cd {{ temp_dir }}/{{ repo.gitea_repo }}
    git remote remove gitea 2>/dev/null || true
    git remote add gitea http://{{ gitea_user }}:{{ gitea_pass }}@10.2.2.40:3001/{{ gitea_user }}/{{ repo.gitea_repo }}.git
    git push -u gitea --all --force
    git push -u gitea --tags --force
  ignore_errors: yes

- name: "[{{ repo.gitea_repo }}] 4. Update Jenkins Jobs"
  include_tasks: update_jenkins_job_url.yml
  loop: "{{ repo.jenkins_jobs }}"
  loop_control:
    loop_var: job_name
  vars:
    gitea_repo_name: "{{ repo.gitea_repo }}"
