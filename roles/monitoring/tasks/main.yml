---
# Prometheus + Grafana 모니터링 스택 설치 (Docker Compose 기반)

# ============================================================================
# Docker 설치
# ============================================================================
- name: 1. podman 제거 (Docker CE 충돌 방지)
  dnf:
    name:
      - podman-docker
      - podman
    state: absent
  ignore_errors: yes

- name: 2. Docker 리포지토리 추가
  get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo

- name: 3. Docker 엔진 및 Compose 설치
  dnf:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present

- name: 4. Docker 서비스 시작
  service:
    name: docker
    state: started
    enabled: yes

# ============================================================================
# 모니터링 스택 설정
# ============================================================================
- name: 5. 모니터링 디렉토리 생성
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/monitoring
    - /opt/monitoring/prometheus
    - /opt/monitoring/grafana/provisioning/datasources
    - /opt/monitoring/grafana/provisioning/dashboards
    - /opt/monitoring/alertmanager

- name: 6. Prometheus 설정 파일 배포
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: 'prometheus.yml.j2', dest: '/opt/monitoring/prometheus/prometheus.yml' }
    - { src: 'alert.rules.yml.j2', dest: '/opt/monitoring/prometheus/alert.rules.yml' }
    - { src: 'alertmanager.yml.j2', dest: '/opt/monitoring/alertmanager/alertmanager.yml' }
    - { src: 'docker-compose.yml.j2', dest: '/opt/monitoring/docker-compose.yml' }

- name: 7. Grafana 프로비저닝 설정
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: 'grafana-datasource.yml.j2', dest: '/opt/monitoring/grafana/provisioning/datasources/prometheus.yml' }
    - { src: 'grafana-dashboards.yml.j2', dest: '/opt/monitoring/grafana/provisioning/dashboards/dashboard.yml' }

- name: 8. Grafana 대시보드 JSON 복사
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: 'node_exporter_full.json', dest: '/opt/monitoring/grafana/provisioning/dashboards/server_monitoring.json' }
    - { src: 'etcd_dashboard.json', dest: '/opt/monitoring/grafana/provisioning/dashboards/etcd_monitoring.json' }

# ============================================================================
# 서비스 시작
# ============================================================================
- name: 9. 모니터링 스택 시작
  shell: |
    cd /opt/monitoring
    docker compose down 2>/dev/null || true
    docker compose up -d
  register: compose_result
  changed_when: true

- name: 10. 서비스 상태 확인
  debug:
    msg: |
      모니터링 스택이 시작되었습니다!
      - Prometheus: http://{{ ansible_host }}:{{ prometheus_port | default(9090) }}
      - Grafana: http://{{ ansible_host }}:{{ grafana_port | default(3000) }}
      - Alertmanager: http://{{ ansible_host }}:{{ alertmanager_port | default(9093) }}

# ============================================================================
# 유지보수 작업
# ============================================================================
- name: 11. 메일함 자동 비우기 (Cron)
  cron:
    name: "{{ item.name }}"
    minute: "{{ item.minute | default(omit) }}"
    hour: "{{ item.hour | default(omit) }}"
    special_time: "{{ item.special_time | default(omit) }}"
    user: root
    job: "/usr/bin/truncate -s 0 /var/mail/root"
    state: present
  loop:
    - { name: 'Clear root mailbox daily 18:00', minute: '0', hour: '18' }
    - { name: 'Clear root mailbox on boot', special_time: 'reboot' }

- name: 12. 미사용 Docker 이미지 정리
  shell: docker image prune -f
  changed_when: false
  ignore_errors: yes